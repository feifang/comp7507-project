<!DOCTYPE html>
<meta charset="utf-8">
<style>

circle {
  fill: rgb(31, 119, 180);
  fill-opacity: .25;
  stroke: rgb(31, 119, 180);
  stroke-width: 1px;
}

.leaf circle {
  fill-opacity: 1;
}

text {
  font: 10px sans-serif;
  text-anchor: middle;
}

</style>
<button name="play" id="play">Play</button>
<svg width="960" height="960"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>

var svg = d3.select("svg"),
    diameter = +svg.attr("width"),
    g = svg.append("g").attr("transform", "translate(2,2)"),
    format = d3.format(",d");

// hierarchy defined by region    
var stratify = d3.stratify()
    .id(function(d) { return d.name; })
    .parentId(function(d) { return d.region; });

var pack = d3.pack()
    .size([diameter - 4, diameter - 4]);
    
// set industry-color mapping 
var color = d3.scaleOrdinal() 
    .domain(["Finance", "Utilities", "Properties", "Commerce & Industry"])
    .range(["#b3cde3","#fbb4ae","#decbe4","#ccebc5"]);

d3.csv("resources/data/HSI_Hierarchy.csv", function(error, data) {
  if (error) throw error;

  // convert csv to d3.hierarchy data, d.r automatically generated by marketcap
  // sum(): define the value of each node (value returned by the specified function + the combined value of all descendants)
  var root = stratify(data)
      .sum(function(d) { return d.marketcap2015; })
      .sort(function(a, b) { return b.value - a.value; });
  
  // pack(root): invoke Pack layout
  // descendants(): Returns the array of descendant nodes, starting with this node, then followed by each child in topological order.
  var node = g.selectAll(".node")
    .data(pack(root).descendants())
    .enter().append("g")
      .attr("class", function(d) { return d.children ? "node" : "leaf node"; }) // apply class for styling
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; }); // locate circles

  // add title for tooltip
  var title = node.append("title")
      		  .text(function(d) { return d.data.name + "\n" + format(d.value); });

  // fill: set color by industry
  var circle = node.append("circle")
      		   .attr("r", function(d) { return d.r; })
      		   .style("fill", function(d) { return color(d.data.industry); });

  // add label: filter and only apply to leaf nodes
  var label = node.filter(function(d) { return !d.children; }).append("text")
      .attr("dy", "0.3em")
      .text(function(d) { return d.data.name.substring(0, d.r / 3); });

  $("button").on("click", function() {
  	update();
	});
		
  function update(){
  
    // update value 
	root
		.sum(function(d) { return d.marketcap2016; })
      	.sort(function(a, b) { return b.value - a.value; });
    
    // update Pack layout
    node.selectAll("g")
    	.data(pack(root).descendants());
    
    // relocate circles
    node.transition()
  		.duration(1000)
  		.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    
    // update tooltip
	title.text(function(d) { return d.data.name + "\n" + format(d.value); });
	
	// update label
	label.text(function(d) { return d.data.name.substring(0, d.r / 3); }); 
	
	// resize circles
  	circle.transition()
  		.duration(1000)
      	.attr("r", function(d) { return d.r; })
      	.style("fill", function(d) { return color(d.data.industry); });
  }
});

</script>